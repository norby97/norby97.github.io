<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>site-centric documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top d-block d-sm-none">
            <a href="../" class="navbar-brand">site-centric documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">













<ol class="breadcrumb">
  <li class="breadcrumb-item">Interfaces</li>
  <li class="breadcrumb-item"
  >
  VisitRow</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/components/finance/view-tracked-procedures/view-tracked-procedures.component.ts</code>
        </p>




        <section data-compodoc="block-index">
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#appointmentDate" 
>
                                            appointmentDate
                                        </a>
                                </li>
                                <li>
                                        <a href="#order" 
>
                                            order
                                        </a>
                                </li>
                                <li>
                                        <a href="#patient" 
>
                                            patient
                                        </a>
                                </li>
                                <li>
                                        <a href="#procedureColumns" 
>
                                            procedureColumns
                                        </a>
                                </li>
                                <li>
                                        <a href="#totalAmount" 
>
                                            totalAmount
                                        </a>
                                </li>
                                <li>
                                        <a href="#visit" 
>
                                            visit
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section data-compodoc="block-properties">
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="appointmentDate"></a>
                                        <span class="name "><b>appointmentDate</b>
                                            <a href="#appointmentDate">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>appointmentDate:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="order"></a>
                                        <span class="name "><b>order</b>
                                            <a href="#order">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>order:         <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="patient"></a>
                                        <span class="name "><b>patient</b>
                                            <a href="#patient">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>patient:         <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="procedureColumns"></a>
                                        <span class="name "><b>procedureColumns</b>
                                            <a href="#procedureColumns">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>procedureColumns:         <code><a href="../interfaces/ProcedureColumn.html" target="_self" >ProcedureColumn[]</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="../interfaces/ProcedureColumn.html" target="_self" >ProcedureColumn[]</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="totalAmount"></a>
                                        <span class="name "><b>totalAmount</b>
                                            <a href="#totalAmount">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>totalAmount:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="visit"></a>
                                        <span class="name "><b>visit</b>
                                            <a href="#visit">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>visit:         <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { formatDate } from &#x27;@angular/common&#x27;;
import { Component, OnInit, ViewChild } from &#x27;@angular/core&#x27;;
import { UntypedFormGroup, UntypedFormControl, Validators } from &#x27;@angular/forms&#x27;;
import { MatOption } from &#x27;@angular/material/core&#x27;;
import { MatDialog } from &#x27;@angular/material/dialog&#x27;;
import { AuthenticationService } from &#x27;src/app/services/administration/authentication.service&#x27;;
import { StudyStartsService } from &#x27;src/app/services/crm_bd/study-starts.service&#x27;;
import { StudyBuildService } from &#x27;src/app/services/finance/study-build.service&#x27;;
import { TrackedVisitsService } from &#x27;src/app/services/finance/tracked-visits.service&#x27;;
import { SiteService } from &#x27;src/app/services/regulatory/site.service&#x27;;
import { UtilService } from &#x27;src/app/services/utils/UtilService&#x27;;
import { saveAs } from &#x27;file-saver&#x27;;
import { PatientMiniViewDialogComponent } from &#x27;../../common/dialogs/ctms/patient-mini-view-dialog/patient-mini-view-dialog.component&#x27;;
import { Observable, of } from &#x27;rxjs&#x27;;
import { UserPreferencesService } from &#x27;src/app/services/utils/user-preferences.service&#x27;;
import { DatepickerHeaderComponent } from &#x27;../../common/dialogs/utils/datepicker-header/datepicker-header.component&#x27;;
import { ScoreCardService } from &#x27;src/app/services/ctms/score-card.service&#x27;;
import { WindowscoreService } from &#x27;src/app/services/utils/window-score.service&#x27;;
import { Sort } from &#x27;@angular/material/sort&#x27;;
interface TrackedProcedure {
  id: string;
  amount: number;
  procedureId: any;
}

interface TrackedVisit {
  visitId: string;
  appointmentDate: string;
  amount: number;
  visitName:string;
  trackedProcedures: TrackedProcedure[];
}

interface Patient {
  id: string;
  gender: string;
  status: string;
  subjectNumber: string;
  trackedVisits: TrackedVisit[];
}



interface ProcedureColumn {
  procedureName: string;
  amount: number;
  procedureId?:any
}

interface VisitRow {
  patient: any;
  visit: any;
  order: any;
  appointmentDate: string;
  totalAmount: number;
  procedureColumns: ProcedureColumn[];
}

interface PatientRow {
  patientId: string;
  visitRows: VisitRow[];
}
@Component({
  selector: &#x27;app-view-tracked-procedures&#x27;,
  templateUrl: &#x27;./view-tracked-procedures.component.html&#x27;,
  styleUrls: [&#x27;./view-tracked-procedures.component.scss&#x27;]
})
export class ViewTrackedProceduresComponent implements OnInit {
  filterForm: UntypedFormGroup;
  noteForm: UntypedFormGroup;
  visits &#x3D; [];
  searched &#x3D; false;
  patients &#x3D; [];
  patientsCopy &#x3D; [];
  patientsCopy2 &#x3D; [];
  patientsCopyo &#x3D; [];
  patientsRef &#x3D; [];
  procedureSums;
  studySelected &#x3D; false;
  selectedStudy;
  studiesloading &#x3D; true;
  projectMNote &#x3D; false;
  simplifiedProcedures;
  simplifiedProcedures2;
  simplifiedProcedureso;
  includepm &#x3D; true;
  sites;
  procedureTotalsByProcedure;
  studies&#x3D;[];
  statuses&#x3D; {
    prescreen:0,
    screen:0,
    screenfail:0,
    prescreenfail:0,
    drop:0,
    enrolled:0,
    completed:0,
    randomized:0
  }
  loading &#x3D;false;
  sums &#x3D; [];
  hsums &#x3D; [];
  details;
  ttotal&#x3D; {
    visits:0,
    cost:0
  }
  skip&#x3D;0;
  highlighted&#x3D;[]
  limit&#x3D;30;
  headerProcedures;
  patientProcedures;
  actualsearchvalue &#x3D;&#x27;&#x27;
  counts &#x3D;[]
  visitmatrix &#x3D; []
  notes;
  all&#x3D;true;
  allsf&#x3D;false;
  patientsloading &#x3D;false;
  @ViewChild(&#x27;allSelected&#x27;) private allSelected: MatOption;
  @ViewChild(&#x27;allSFSelected&#x27;) private allSFSelected: MatOption;
  dpheader;

  constructor(private siteService: SiteService,
              private dialog: MatDialog,
              private authService: AuthenticationService,
              private scoreCardService: ScoreCardService,
              private windowService: WindowscoreService,
              public utilService: UtilService,
              private studyBuildService: StudyBuildService,
              private trackedVisitService:TrackedVisitsService,
              private userPreferences: UserPreferencesService) {
                this.dpheader &#x3D; DatepickerHeaderComponent;

               }

  ngOnInit(): void {
    this.filterForm &#x3D; new UntypedFormGroup({
      site: new UntypedFormControl(&#x27;&#x27;, Validators.required),
      study: new UntypedFormControl(&#x27;&#x27;, Validators.required),
      procedure: new UntypedFormControl(&#x27;ALL_PROCEDURES&#x27;, Validators.required),
      dateFrom: new UntypedFormControl(&#x27;&#x27;),
      dateTo: new UntypedFormControl(&#x27;&#x27;,),
      patients: new UntypedFormControl(&#x27;&#x27;, Validators.required),
    }); 
    this.noteForm &#x3D; new UntypedFormGroup({
      sites:new UntypedFormControl([]),
      note: new UntypedFormControl(&#x27;&#x27;, Validators.required)
    })
    if(JSON.parse(localStorage.getItem(&#x27;siteCentric.sites&#x27;))?.length !&#x3D; 0 &amp;&amp; JSON.parse(localStorage.getItem(&#x27;siteCentric.sites&#x27;)) !&#x3D; null )   {
      this.sites &#x3D; JSON.parse(localStorage.getItem(&#x27;siteCentric.sites&#x27;));
      this.filterForm.controls.site.setValue(this.sites.find(elem &#x3D;&gt; elem?.id &#x3D;&#x3D; JSON.parse(localStorage.getItem(&#x27;scUserSettings&#x27;))?.selectedSite?.id));
      this.filterForm.controls.site.updateValueAndValidity();
    } else {
       this.siteService.getAll2(this.authService.loginUserValue.company.id).subscribe(res &#x3D;&gt; {
        localStorage.setItem(&#x27;siteCentric.sites&#x27;, JSON.stringify(res));
        this.sites &#x3D; res;
        this.filterForm.controls.site.setValue(this.sites.find(elem &#x3D;&gt; elem?.id &#x3D;&#x3D; JSON.parse(localStorage.getItem(&#x27;scUserSettings&#x27;))?.selectedSite?.id));
        this.filterForm.controls.site.updateValueAndValidity();
      });
    }
  }



  searcher2 &#x3D; (search: string, pageNumber: number, pageSize: number):Observable&lt;any[]&gt; &#x3D;&gt; { 
    const data &#x3D; {
      studyName:search,
      skip:this.skip+((pageNumber-1)*this.limit),
      limit:this.limit,
      dateFrom:this.filterForm.controls.dateFrom.value !&#x3D;&#x27;&#x27; ? formatDate(this.filterForm.controls.dateFrom.value, &#x27;yyyy-MM-dd&#x27;, &#x27;en-Us&#x27;): &#x27;&#x27;,
      dateTo:this.filterForm.controls.dateTo.value !&#x3D;&#x27;&#x27; ? formatDate(this.filterForm.controls.dateTo.value, &#x27;yyyy-MM-dd&#x27;, &#x27;en-Us&#x27;) : &#x27;&#x27;,
      siteId: this.filterForm.controls.site.value.id,
    }
    if(pageNumber - 1 !&#x3D; 0) {
      this.trackedVisitService.getTrackedVisitsStudies(data).subscribe(res &#x3D;&gt; {
        this.studies &#x3D; [...this.studies, ...res];
      })
    } else {
      this.studiesloading &#x3D;true;
      this.searched &#x3D; false;
      this.studies &#x3D; [];
      this.trackedVisitService.getTrackedVisitsStudies(data).subscribe(res &#x3D;&gt; {
        this.studies &#x3D; [...res];
        this.studiesloading &#x3D;false;
      })
    }
    return of(this.studies)
  }
  

  getPatients(event,study) {
    this.studySelected &#x3D; true;
    this.searched &#x3D; false;
    this.all &#x3D; true;
    this.allsf &#x3D; false;
    this.patientsloading &#x3D; true;
    this.selectedStudy &#x3D;  study.ngControl.valueAccessor.selected.viewValue;

    this.trackedVisitService.getPatients(event.value).subscribe(res &#x3D;&gt; {
      this.patients &#x3D; res;
      this.patientsRef&#x3D; res;

      this.toggleAllSelection(true);
      this.patientsloading &#x3D;false;
    })
  }
    
  submit() {

    if(this.filterForm.valid &amp;&amp; this.patients?.length) {
      this.userPreferences.setuserState(&#x27;selectedSite&#x27;,this.filterForm.controls.site.value,true)

      this.loading &#x3D; true;
      this.searched &#x3D; true;
      const data &#x3D; {
        studyId: this.filterForm.controls.study.value,
        procedureTypeFilter: this.filterForm.controls.procedure.value,
        dateFrom:this.filterForm.controls.dateFrom.value ? formatDate(this.filterForm.controls.dateFrom.value, &#x27;yyyy-MM-dd&#x27;, &#x27;en-Us&#x27;) : &#x27;&#x27;,
        dateTo: this.filterForm.controls.dateTo.value ? formatDate(this.filterForm.controls.dateTo.value, &#x27;yyyy-MM-dd&#x27;, &#x27;en-Us&#x27;) : &#x27;&#x27;,
        patientStudyLinkIds: this.all ? &#x27;&#x27; :this.filterForm.controls.patients.value,
      }
     
      this.trackedVisitService.getTrackedProceduresForHeader(this.filterForm.controls.study.value).subscribe(res &#x3D;&gt; {
        this.headerProcedures &#x3D; res.sort((a,b)&#x3D;&gt; this.compare(a?.name?.toLowerCase() , b?.name?.toLowerCase(),true));;
        this.headerProcedures.forEach(elem &#x3D;&gt; {
          this.sums.push(0);
        })
        this.trackedVisitService.getTrackedProcedures(data).subscribe(res &#x3D;&gt; {
          this.patientProcedures &#x3D; res;
          this.patientsCopy &#x3D; res;
          this.patientsCopy2 &#x3D; res;
          this.patientsCopyo &#x3D; res;

          this.visitmatrix &#x3D; []
          this.highlighted &#x3D; []
          this.sums &#x3D; [];
          this.hsums &#x3D; [];


          const patients: Patient[] &#x3D;res 
          let it &#x3D; 0
          const visitRows: VisitRow[] &#x3D; [];

          // Extract all procedures
          const procedures: any[]  &#x3D;   this.headerProcedures
       

          // Create VisitRows
          for (const patient of patients) {
            for (const trackedVisit of patient.trackedVisits) {
              const procedureColumns: ProcedureColumn[] &#x3D; [];

              for (const procedureId of procedures) {
                const procedureName &#x3D;  &#x60;${procedureId.name}&#x60;;
                const trackedProcedure &#x3D; trackedVisit.trackedProcedures.find(
                  (tp) &#x3D;&gt; tp.procedureId &#x3D;&#x3D; procedureId.id
                );
                const amount &#x3D; trackedProcedure ? trackedProcedure.amount : 0;
                procedureColumns.push({ procedureName, amount, procedureId:&#x60;${procedureId.id}&#x60;});
              }

              const visitRow: VisitRow &#x3D; {
                patient: patient,
                visit: trackedVisit,
                order:it,
                appointmentDate: trackedVisit.appointmentDate,
                totalAmount: trackedVisit.amount ? trackedVisit.amount : 0,
                procedureColumns,
              };

              visitRows.push(visitRow);
            }
            it++
          }

          this.simplifiedProcedures &#x3D; visitRows
          this.simplifiedProcedures2 &#x3D; visitRows
          this.simplifiedProcedureso &#x3D; visitRows
          let it2&#x3D;0
          const procedureSums&#x3D; [];
          for (const patient of visitRows) {
            let procedureName;
            let sum &#x3D; 0;
            for (const procedure of patient.procedureColumns) {
              procedureName &#x3D; &#x60;${procedure.procedureName}&#x60;;
              sum +&#x3D; procedure?.amount  ? procedure.amount : 0;
            }
            procedureSums.push({ procedureName, order:it2, amount: sum, });
            it2++;
          }

          this.procedureSums &#x3D; procedureSums
          
          const procedureTotalsByProcedure: Record&lt;string, number&gt; &#x3D; {};

          for (const patient of patients) {
            const procedureTotals: Record&lt;string, number&gt; &#x3D; {};

            for (const trackedVisit of patient.trackedVisits) {
              for (const trackedProcedure of trackedVisit.trackedProcedures) {
                const procedureId &#x3D; trackedProcedure.procedureId;
                const amount &#x3D; trackedProcedure.amount  ? trackedProcedure.amount : 0;

                const procedureName &#x3D; &#x60;${procedureId}&#x60;;
                if (procedureTotals[procedureName]) {
                  procedureTotals[procedureName] +&#x3D; amount;
                } else {
                  procedureTotals[procedureName] &#x3D; amount;
                }

                if (procedureTotalsByProcedure[procedureName]) {
                  procedureTotalsByProcedure[procedureName] +&#x3D; amount;
                } else {
                  procedureTotalsByProcedure[procedureName] &#x3D; amount;
                }
              }
            }

          }
          this.procedureTotalsByProcedure &#x3D; procedureTotalsByProcedure;
          
          this.ttotal.cost &#x3D; this.procedureSums.reduce((partialSum, a) &#x3D;&gt;this.utilService.sumFloatNumbers(partialSum,a.amount ?? 0) , 0);

    
         
          this.patientsCopy.map((elem,i) &#x3D;&gt; {
            elem.order &#x3D;i
            this.hsums.push(0);
            this.highlighted.push(false);
  
             
              this.visitmatrix.push([])
            })
            this.patientsCopy2.map((elem,i) &#x3D;&gt; {
              elem.order &#x3D;i
              })   
              this.patientsCopyo.map((elem,i) &#x3D;&gt; {
                elem.order &#x3D;i
               
                })
          this.patientsCopy.map((patient:{trackedVisits:any[]},i) &#x3D;&gt; {
            this.headerProcedures?.map((visit,j) &#x3D;&gt; {
              this.visitmatrix[i][j] &#x3D; []
            patient.trackedVisits?.map(visits &#x3D;&gt; {
              let visitadded &#x3D; false
              
              visits.trackedProcedures.map(procedure &#x3D;&gt; {

                    if(procedure.procedureId &#x3D;&#x3D; visit.id) {
                      visitadded &#x3D; true;
                      this.visitmatrix[i][j] &#x3D; procedure;
                    } 
                  })
                  if(!visitadded) this.visitmatrix[i][j] &#x3D; null;

              })
            
            })
          })

          this.sums.fill(0);
          this.counts.fill(0);
          this.hsums.fill(0)
          this.getTotals();
          this.loading &#x3D; false;
          this.searched &#x3D;true;
        }, err &#x3D;&gt; {
          this.loading &#x3D; false;
        })
      }, err &#x3D;&gt; {
        this.loading &#x3D; false;
      })

    } else {
      this.loading &#x3D; false;
      this.searched &#x3D; false;
      this.filterForm.markAllAsTouched();
    }
  }

export() {
  const data &#x3D; {
    studyId: this.filterForm.controls.study.value,
    procedureTypeFilter: this.filterForm.controls.procedure.value,
    dateFrom:this.filterForm.controls.dateFrom.value !&#x3D;&#x27;&#x27; ? formatDate(this.filterForm.controls.dateFrom.value, &#x27;yyyy-MM-dd&#x27;, &#x27;en-Us&#x27;) : &#x27;&#x27;,
    dateTo: this.filterForm.controls.dateTo.value !&#x3D;&#x27;&#x27; ? formatDate(this.filterForm.controls.dateTo.value, &#x27;yyyy-MM-dd&#x27;, &#x27;en-Us&#x27;) : &#x27;&#x27;,
    patientStudyLinkIds: this.all ? &#x27;&#x27; :this.filterForm.controls.patients.value,
  }
  this.trackedVisitService.getTrackedProceduresCSV(data).subscribe(res &#x3D;&gt; {
    const blob &#x3D; new Blob([res], {  type: &quot;text/csv;charset&#x3D;utf-8&quot;} );
    saveAs(blob, this.selectedStudy + &#x27; &#x27;+this.filterForm.controls.procedure.value+&#x27; &#x27;+ (this.filterForm.controls.dateFrom.value &#x3D;&#x3D; &#x27;&#x27; ? &#x27;&#x27; : formatDate(new Date(this.filterForm.controls.dateFrom.value),&#x27;MM/dd/yyyy&#x27;,&#x27;en-Us&#x27;))  + &#x27; - &#x27;+(this.filterForm.controls.dateTo.value &#x3D;&#x3D; &#x27;&#x27; ? &#x27;&#x27; :formatDate(new Date(this.filterForm.controls.dateTo.value),&#x27;MM/dd/yyyy&#x27;,&#x27;en-Us&#x27;))+ &#x27; - Tracked Procedures.csv&#x27;);    
  })
}
 

  
  openPatientMiniViewDialog(patient, type&#x3D;0) {
    patient.patientFullName &#x3D;&#x3D; patient.alias;
    const ref &#x3D; this.dialog.open(PatientMiniViewDialogComponent, {
      width: &#x27;auto&#x27;,
      minWidth:&#x27;50vw&#x27;,
      maxHeight:&#x27;80vh&#x27;,
    panelClass:&#x27;custom-dialog-container&#x27;,
    maxWidth:&#x27;80vw&#x27;,
      height:&#x27;auto&#x27;,
      disableClose: true,
      data: {
        fromTracking:false,
        patient: type &#x3D;&#x3D; 0 ? patient : {patientId: patient.patientId},
        site:   this.filterForm.controls.site.value.id,
      }
    });
    
  }
  
  getTotals(){
        this.visitmatrix.forEach((elem,i) &#x3D;&gt;{
        elem.forEach(visit &#x3D;&gt; {
        if(visit !&#x3D; null) {
          this.hsums[i] &#x3D;this.utilService.sumFloatNumbers(visit.amount ?? 0,this.hsums[i]);
        }
      })
    })
    for(let i &#x3D; 0; i&lt;this.headerProcedures?.length; i++) {
      this.sums[i] &#x3D; this.getColumnSum(i)
    }

 
  }

  getColumnSum(j) {
    let sum &#x3D; 0
    for(let i &#x3D; 0; i&lt;this.visitmatrix.length; i++) {
      if(this.visitmatrix[i][j]!&#x3D;null) {
          sum&#x3D;this.utilService.sumFloatNumbers(this.visitmatrix[i][j].amount ?? 0,sum);



      }
    }
    return sum;
  }


  searcher22 &#x3D; (search: string, pageNumber: number, pageSize: number):Observable&lt;any[]&gt; &#x3D;&gt; { 
  
    this.actualsearchvalue&#x3D;search;
      let temp &#x3D; []
      if(search &#x3D;&#x3D; &#x27;&#x27;) {
          this.patients &#x3D; this.patientsRef;
      } else {
          this.patientsRef.map(elem &#x3D;&gt; {
              if(elem.alias?.toLowerCase().indexOf(search.toLowerCase()) &gt; -1  || elem.subjectNumber?.toLowerCase().indexOf(search.toLowerCase()) &gt; -1 ) {
                  temp.push(elem);
              }
          });
          this.patients &#x3D; temp;
      }
      
      return of(this.patients)
    }
  
  tosslePerOne(all){ 
    if (this.all) {  
     this.all &#x3D; false;
     return false;
 }
  if (this.allsf) {  
    this.allsf&#x3D; false;
    return false;
  }
   if(this.filterForm.controls.patients.value.length&#x3D;&#x3D;this.patients.length &amp;&amp; this.actualsearchvalue &#x3D;&#x3D;&#x27;&#x27;){

     this.all &#x3D;true;
   }

 }





  sortData(sort: Sort) {
  
    const data &#x3D; this.patientsCopy.slice();
    if (!sort.active || sort.direction &#x3D;&#x3D;&#x3D; &#x27;&#x27;) {
      this.patientsCopy2 &#x3D; this.patientsCopyo;
      this.patientsCopy &#x3D; this.patientsCopyo;
    }
     this.patientsCopy2&#x3D; data.sort((a, b) &#x3D;&gt; {
      const isAsc &#x3D; sort.direction &#x3D;&#x3D;&#x3D; &#x27;asc&#x27;;
      switch (sort.active) {
        case &#x27;patientname&#x27;: return this.compare(a.alias?.toLowerCase() , b.alias?.toLowerCase(), isAsc);
        default: return 0;
      }
    });
    this.patientsCopy &#x3D; this.patientsCopy2;

    const patients: Patient[] &#x3D;this.patientsCopy 
    let it &#x3D; 0
    const visitRows: VisitRow[] &#x3D; [];

    // Extract all procedures
    const procedures: any[]  &#x3D;   this.headerProcedures
       

    // Create VisitRows
    for (const patient of patients) {
      for (const trackedVisit of patient.trackedVisits) {
        const procedureColumns: ProcedureColumn[] &#x3D; [];

        for (const procedureId of procedures) {
          const procedureName &#x3D;  &#x60;${procedureId.name}&#x60;;
          const trackedProcedure &#x3D; trackedVisit.trackedProcedures.find(
            (tp) &#x3D;&gt; tp.procedureId &#x3D;&#x3D; procedureId.id
          );
          const amount &#x3D; trackedProcedure ? trackedProcedure.amount : 0;
          procedureColumns.push({ procedureName, amount, procedureId:&#x60;${procedureId.id}&#x60;});
        }

        const visitRow: VisitRow &#x3D; {
          patient: patient,
          order: it,
          visit: trackedVisit,
          appointmentDate: trackedVisit.appointmentDate,
          totalAmount: trackedVisit.amount ? trackedVisit.amount : 0,
          procedureColumns,
        };

        visitRows.push(visitRow);
      }
    }

    this.simplifiedProcedures &#x3D; visitRows
    let it2&#x3D;0
    const procedureSums&#x3D; [];
    for (const patient of visitRows) {
      let procedureName;
      let sum &#x3D; 0;
      for (const procedure of patient.procedureColumns) {
        procedureName &#x3D; &#x60;${procedure.procedureName}&#x60;;
        sum +&#x3D; procedure?.amount  ? procedure.amount : 0;
      }
      procedureSums.push({ procedureName, order:it2, amount: sum, });
      it2++;
    }

    this.procedureSums &#x3D; procedureSums
  }
  compare(a: number | string, b: number | string, isAsc: boolean) {
    return (a &lt; b ? -1 : 1) * (isAsc ? 1 : -1);
  }
toggleAllSelection(status) {
  this.all &#x3D; status
  this.allsf&#x3D;false;
  if ( this.all) {
    this.filterForm.controls.patients
      .patchValue([...this.patientsRef.map(item &#x3D;&gt; item.id),0]);    
      this.filterForm.controls.patients.updateValueAndValidity();

  } else {
    this.filterForm.controls.patients.patchValue(&#x27;&#x27;);
    this.filterForm.controls.patients.updateValueAndValidity();

  }
  }
  toggleAllSFSelection(status) {
  this.allsf &#x3D; status
  this.all&#x3D;false;

    if (this.allsf) {
      this.filterForm.controls.patients
        .patchValue([...this.patientsRef.filter(item &#x3D;&gt; item.status &#x3D;&#x3D; &#x27;SCREEN_FAIL&#x27;).map(obj &#x3D;&gt; obj.id),1]);
        this.filterForm.controls.patients.updateValueAndValidity();

    } else {      
      this.filterForm.controls.patients.patchValue(&#x27;&#x27;);
      this.filterForm.controls.patients.updateValueAndValidity();

    }
  }

  openInNewWindow(score,i) {
  
  this.windowService.open( score,  this.selectedStudy?.replace(&#x27;(&#x27;,&#x27;&#x27;).replace(&#x27;)&#x27;,&#x27;&#x27;).replace(&#x27;/&#x27;,&#x27;&#x27;)  )
   
    }
}
</code></pre>
    </div>
</div>








                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'VisitRow.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
